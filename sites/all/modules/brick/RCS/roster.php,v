head	1.5;
access;
symbols;
locks; strict;
comment	@# @;


1.5
date	2013.06.02.20.28.59;	author benson;	state Exp;
branches;
next	1.4;

1.4
date	2013.02.26.05.24.14;	author benson;	state Exp;
branches;
next	1.3;

1.3
date	2012.06.13.08.44.39;	author benson;	state Exp;
branches;
next	1.2;

1.2
date	2012.06.13.02.02.40;	author ubuntu;	state Exp;
branches;
next	1.1;

1.1
date	2012.05.16.02.17.27;	author crc;	state Exp;
branches;
next	;


desc
@@


1.5
log
@roster will have one page even if no one is signed up.  also initialized some vars
@
text
@<?php 

include("fpdf.php");

function generate_waiver($pdf) {
  $pdf->Ln(10);
  $pdf->Cell(690,160,'',1,0,'L',0);
  $pdf->Ln(1);
  $pdf->Cell(150);
  $pdf->SetFont('Arial', 'B',10);
  $pdf->Cell(370,20,'Waiver, Assumption of Risk and Release',0,1,'C',0);
  $pdf->Ln(1);
  $pdf->SetFont('Arial', '',6);
  $pdf->Write(8, 'I, the abovesigned, wish to volunteer my services to various community service organizations and projects through you, One Brick, a California nonprofit corporation ("One Brick"). In consideration of your locating, arranging, coordinating and/or making available volunteer opportunities, I hereby agree and release you as follows:');
  $pdf->Ln();
  $pdf->Cell(10);
  $pdf->Write(8, '1.  I acknowledge and agree that the nature of the volunteer services which are typically performed by One Brick volunteers, and which may be performed by me as a One Brick volunteer, can pose serious risks of injury or death and may involve (a) strenuous physical activity (including without limitation work with heavy tools and materials), (b) contact with unidentified and unfamiliar persons, (c) travel to and from various unspecified locations, and (d) other potential risk of injury. Knowing the risks involved, nevertheless, I have voluntarily applied to participate as a volunteer and hereby agree to assume any and all risks of injury or death or damage to personal property and to release and hold harmless One Brick, its directors, officers, partners, agents, employees, successors, assigns, licensees, sponsors, donors, representatives, guests and affiliates who through negligence, carelessness or any other act or omission in connection with my participation as a One Brick volunteer might otherwise be liable to me.');
  $pdf->Ln();
  $pdf->Cell(10);
  $pdf->Write(8, '2.  I hereby release and forever discharge and hold harmless One Brick and its directors, officers, partners, agents, employees, successors, assigns, licensees, sponsors, donors, representatives, guests and affiliates from and covenants not to sue any of them for, any and all liability, claims and causes of action, whether known or unknown, arising out of, based upon or relating to my participation as an One Brick volunteer or in any One Brick related activity or project, even though such liability, claims or causes of action might arise out of negligence or carelessness on the part of One Brick, its directors, officers, partners, agents, employees, successors, assigns, licensees, sponsors, donors, representatives, guests or affiliates.');
  $pdf->Ln();
  $pdf->Cell(10);
  $pdf->Write(8, '3.  I further understand and agree that this waiver, release and assumption of risks is to be binding on my heirs and assigns. I am fully aware that One Brick carries no medical or other insurance for any volunteers. I also understand that One Brick does not assume any responsibility or obligation to provide financial assistance or other assistance, including, but not limited to, medical, health, or disability insurance, in the event of injury, illness, death, or property damage. AS A VOLUNTEER, I AM EXPECTED AND ENCOURAGED BY ONE BRICK TO MAINTAIN MEDICAL, HEALTH, AND ALL OTHER APPLICABLE INSURANCE COVERAGE FOR MY OWN BENEFIT.');
  $pdf->Ln();
  $pdf->Cell(10);
  $pdf->Write(8, '4.  I further irrevocably grant to One Brick, its assigns and successors, my consent and full right to: use my name, photograph, likeness, image, voice and biography in any and all media, publications, advertising, and publicity, in connection with my participation hereunder.');
  $pdf->Ln();
  $pdf->Cell(10);
  $pdf->Write(8, '5.  This release shall inure to the benefit of One Brick, as well as to the benefit of its successors, licensee, agents, employees, affiliates and assigns. ');
  $pdf->Ln(20);
}

function generate_page_top($pdf, $node, $event_contact, $page) {
  $num_blanks = 0;

  $pdf->Cell(485);
  $pdf->SetFont('Arial', 'B',8);
  $pdf->Cell(200,12,''.strip_tags($node->title),0,1,'R',0);

  $pdf->Cell(485);
  $pdf->SetFont('Arial', 'B',8);
  $ts_from = strtotime($node->field_event_date['und'][0]['value']);
  $ts_to = strtotime($node->field_event_date['und'][0]['value2']); 
  $pdf->Cell(200,12,date('M j, Y, g:i A', $ts_from).' - '.date('g:i A', $ts_to),0,1,'R',0);

  $contact_name = trim($event_contact['field_user_fullname_value']);
  if ($contact_name != '') {
    $contact_name = ' '.$contact_name;
  }
  $contact_phone = trim($event_contact['field_user_phone_value']);
  if ($contact_phone != '') {
    $contact_phone = ', '.$contact_phone;
  }
  $contact_email = trim($event_contact['mail']);
  if ($contact_email != '') {
    $contact_email = ', '.$contact_email;
  }
  $contact_info = trim(trim(($contact_name).($contact_phone).($contact_email)));
  if ($contact_info != '') {
    $pdf->Cell(485);
    $pdf->SetFont('Arial', 'B',8);
    $pdf->Cell(200,12,$contact_info,0,1,'R',0);
  } else {
    $num_blanks++;
  }

  if(isset($node->field_event_site)) {
    $site = node_load($node->field_event_site['und']['0']['nid']);
    if(isset($site->location)) {
      $address_info = location_address2singleline($site->location);
    }
  }

  if ($address_info != '') {
    $pdf->Cell(485);
    $pdf->SetFont('Arial', 'B',8);
    $pdf->Cell(200,12,$address_info,0,1,'R',0);
  } else {
    $num_blanks++;
  }

  $pdf->Cell(485);
  $pdf->SetFont('Arial', 'B',8);
  $pdf->Cell(200,12,'Page #'.$page,0,1,'R',0);
  
  for ($i = 0; $i < $num_blanks; $i++) {
    $pdf->Cell(485);
    $pdf->SetFont('Arial', 'B',8);
    $pdf->Cell(200,12,'',0,1,'R',0);
  }

  $pdf->Image('sites/default/files/logo.gif',45,20,99,62);

  $pdf->Ln(7);
}


function get_roster($node) {
	// IDs of volunteers
	$q = "SELECT field_rsvp_person_uid
		FROM field_data_field_rsvp_person
		LEFT JOIN field_data_field_rsvp_event
		ON field_data_field_rsvp_event.entity_id = field_data_field_rsvp_person.entity_id
		WHERE field_rsvp_event_nid = $node->nid
	";

	$roster = db_query_temporary($q);

	// IDs of non-newbies
	$q = "SELECT distinct field_data_field_rsvp_person.field_rsvp_person_uid
		FROM $roster
		LEFT JOIN (field_data_field_rsvp_person, field_data_field_rsvp_attended)
		ON field_data_field_rsvp_person.field_rsvp_person_uid = $roster.field_rsvp_person_uid
		AND field_data_field_rsvp_attended.entity_id = field_data_field_rsvp_person.entity_id
		WHERE field_rsvp_attended_value = 1;
	";

	$r = db_query($q);

	// array of non-newbie IDs
        $non_newbies = array();
	while ($record = $r->fetchAssoc()) {
		$non_newbies[] = $record['field_rsvp_person_uid'];
	}


	$q = "SELECT $roster.field_rsvp_person_uid as id, field_user_fullname_value
		FROM $roster
		LEFT JOIN field_data_field_user_fullname
		ON field_data_field_user_fullname.entity_id = $roster.field_rsvp_person_uid
		ORDER BY field_user_fullname_value;
	";

	$r = db_query($q);

     	$all_volunteers = array();
	while ($record = $r->fetchAssoc()) {
		if (in_array($record['id'], $non_newbies)) {
			$record['previous'] = 1;
		} else {
			$record['previous'] = 0;
		}
		$all_volunteers[] = $record;
	}

	$org = $node->field_event_organization['und'][0]['nid'];
	$q = "SELECT mail, field_user_fullname_value, field_user_phone_value
		FROM field_data_field_org_contact_organization, field_data_field_user_fullname, field_data_field_user_phone, users
		WHERE field_org_contact_organization_nid = $org
		AND field_data_field_user_fullname.entity_id = field_data_field_org_contact_organization.entity_id
		AND field_data_field_user_fullname.entity_id = field_data_field_user_phone.entity_id
		AND field_data_field_user_fullname.entity_id = users.uid;
	";

	$r = db_query($q);

	while ($record = $r->fetchAssoc()) {
		$event_contact[] = $record;
	}

	return array($all_volunteers, $event_contact[0]);
}

function get_org_info($id) {
	return $org;
}

function generate_pdf($nid) { 
	$node = node_load($nid);

	list($all_volunteers, $event_contact) = get_roster($node);

	$pdf = new fpdf('L', 'pt', 'Letter');

	$row_height='20';
	$printed_width = 125;
	$signed_width=200;
	$cell_border = 'B';

	$pdf->SetMargins(50, 20, 50,10); // left, top, right
	$pdf->SetAutoPageBreak(true, 50); // this is the bottom margin
	$pdf->SetDisplayMode('fullwidth', 'continuous');

	$max_columns = 2;
	$max_rows = 12;

	$num_spaces = sizeof($all_volunteers) * 1.2; // allocate space for 20% walk-ins
	$num_volunteers_per_page = $max_columns * $max_rows;
	$num_pages = intval(ceil($num_spaces / $num_volunteers_per_page));
        // Want at least 1 page (even if no one signed up)
        $num_pages = max(1, $num_pages);

	$num_newbies = 0;
	for ($page = 0; $page < $num_pages; $page++) {
	  $pdf->AddPage();

	  generate_page_top($pdf, $node, $event_contact, $page+1);

	  $pdf->SetFont('Arial', 'B',10);
	  $pdf->Write(11, 'BY SIGNING BELOW, YOU AGREE TO THE WAIVER, ASSUMPTION OF RISK AND RELEASE AT THE BOTTOM OF THE PAGE');
	  $pdf->Ln(15);

	  $pdf->SetFillColor(224);
	  $pdf->SetFont('Arial', 'B',8);

	  // header
	  $pdf->Cell($printed_width,$row_height,'Name',$cell_border,0,'L',1);
		$pdf->Cell(8,$row_height,'',0,0,'L',0);
	  $pdf->Cell($signed_width,$row_height,'Signature',$cell_border,0,'L',1);
		$pdf->Cell(20,$row_height,'',0,0,'L',0);
	  $pdf->Cell($printed_width,$row_height,'Name',$cell_border,0,'L',1);
		$pdf->Cell(8,$row_height,'',0,0,'L',0);
	  $pdf->Cell($signed_width,$row_height,'Signature',$cell_border,1,'L',1);

	  /////////////////////////////////////////////

	  $pdf->SetFillColor(224);
	  $pdf->SetFont('Arial', 'B',12);

	  // print names and blanks
	  for ($row = 0; $row < $max_rows; $row++) {
	    for ($col = 0; $col < $max_columns; $col++) {
	      $volunteer_index = ($page * 24) + ($col * 12) + ($row);
	      
	      // space should contain volunteer info
	      if ($volunteer_index < sizeof($all_volunteers)) {
		$volunteer = $all_volunteers[$volunteer_index];
		
		if($volunteer['previous']==0) { 
		  $newbie="(*)";
		  $num_newbies++;
		} else { 
		  $newbie="";
		}
	  
		$pdf->Cell($printed_width,$row_height,''.$volunteer['field_user_fullname_value'].' '.($newbie).'',$cell_border,0,'L',0);
		$pdf->Cell(8,$row_height,'',0,0,'L',0);
	      } else {
		$pdf->Cell($printed_width,$row_height,'',$cell_border,0,'L',0);
		$pdf->Cell(8,$row_height,'',0,0,'L',0);
	      }
	      
	      if($col == 0) { 
		$pdf->Cell($signed_width,$row_height,'',$cell_border,0,'L',0);
		$pdf->Cell(20,$row_height,'',0,0,'L',0);
	      } else { 
		$pdf->Cell($signed_width,$row_height,'',$cell_border,1,'L',0);
	      }
	    }
	  }

	  generate_waiver($pdf);

	  $pdf->SetFont('Arial', 'B',10);
	  $pdf->Cell(300,$row_height,'(*) This is your first time with One Brick.  Welcome!',0,1,'L',0);
	}

	return $pdf->Output('PDF_Roster.pdf', 'D');
}

?>
@


1.4
log
@*** empty log message ***
@
text
@d121 1
d136 1
d190 2
@


1.3
log
@done!
@
text
@d92 1
a92 1
  $pdf->Image('sites/default/files/ob_logo_small.png',45,20,99,62);
d251 1
a251 101
	  $pdf->Cell(300,$row_height,'(*) This is your first time with One Brick.  Please complete the Volunteer Information page.',0,1,'L',0);
	}
	  
	// generate pages for newbies
	$num_newbies = $num_newbies * 1.05 + 1; // compensate for possible walk-ins

	$num_lines_per_page = 10;
	$num_newbie_pages = intval(ceil($num_newbies / $num_lines_per_page));

	$newbie_row_height = 40;
	$newbie_name_width = 90;
	$newbie_address_width = 140;
	$newbie_email_width = 100;
	$newbie_phone_width = 57;
	$newbie_employer_width = 60;
	$newbie_gender_width = 35;
	$newbie_dob_width = 43;
	$newbie_how_hear_width = 140;
	$newbie_spacer = 3;

	for ($newbie_page = 0; $newbie_page < $num_newbie_pages; $newbie_page++, $page++) {
	  $pdf->AddPage();
                          
	  generate_page_top($pdf, $node, $event_contact, $page+1);

	  $pdf->SetFont('Arial', 'B',10);
	  $pdf->Write(11, 'THIS PAGE MUST BE COMPLETED BY ALL FIRST-TIME VOLUNTEERS');
	  $pdf->Ln(15);

	  $pdf->SetFillColor(224);
	  $pdf->SetFont('Arial', 'B',8);

	  $pdf->Cell($newbie_name_width,$row_height,'Name',$cell_border,0,'L',1);
	    $pdf->Cell($newbie_spacer,$row_height,'',0,0,'L',0);
	  $pdf->Cell($newbie_address_width,$row_height,'Address',$cell_border,0,'L',1);
	    $pdf->Cell($newbie_spacer,$row_height,'',0,0,'L',0);	    
	  $pdf->Cell($newbie_email_width,$row_height,'Email',$cell_border,0,'L',1);
	    $pdf->Cell($newbie_spacer,$row_height,'',0,0,'L',0);
	  $pdf->Cell($newbie_phone_width,$row_height,'Phone',$cell_border,0,'L',1);
	    $pdf->Cell($newbie_spacer,$row_height,'',0,0,'L',0);
	  $pdf->Cell($newbie_employer_width,$row_height,'Employer',$cell_border,0,'L',1);
	    $pdf->Cell($newbie_spacer,$row_height,'',0,0,'L',0);
	  $pdf->Cell($newbie_gender_width,$row_height,'Gender',$cell_border,0,'L',1);
	    $pdf->Cell($newbie_spacer,$row_height,'',0,0,'L',0);
	  $pdf->Cell($newbie_dob_width,$row_height,'Birthdate',$cell_border,0,'L',1);
	    $pdf->Cell($newbie_spacer,$row_height,'',0,0,'L',0);
	  $pdf->Cell($newbie_how_hear_width,$row_height,'How did you hear about us?',$cell_border,1,'L',1);

	  // example line
	  $pdf->SetFillColor(224);
	  $pdf->SetFont('Arial', 'BI',10);

	  $pdf->Cell($newbie_name_width,$row_height,'Jane',0,0,'L',0);
	    $pdf->Cell($newbie_spacer,$row_height,'',0,0,'L',0);
	  $pdf->Cell($newbie_address_width,$row_height,'1234 Main Street',0,0,'L',0);
	    $pdf->Cell($newbie_spacer,$row_height,'',0,0,'L',0);	    
	  $pdf->Cell($newbie_email_width,$row_height,'janedoe@@',0,0,'L',0);
	    $pdf->Cell($newbie_spacer,$row_height,'',0,0,'L',0);
	  $pdf->Cell($newbie_phone_width,$row_height,'(123)',0,0,'L',0);
	    $pdf->Cell($newbie_spacer,$row_height,'',0,0,'L',0);
	  $pdf->Cell($newbie_employer_width,$row_height,'One',0,0,'L',0);
	    $pdf->Cell($newbie_spacer,$row_height,'',0,0,'L',0);
	  $pdf->Cell($newbie_gender_width,$row_height,'F',0,0,'L',0);
	    $pdf->Cell($newbie_spacer,$row_height,'',0,0,'L',0);
	  $pdf->Cell($newbie_dob_width,$row_height,'01/01',0,0,'L',0);
	    $pdf->Cell($newbie_spacer,$row_height,'',0,0,'L',0);
	  $pdf->Cell($newbie_how_hear_width,$row_height,'Friend',0,1,'L',0);

	  $pdf->Cell($newbie_name_width,$row_height,'Doe',$cell_border,0,'L',0);
	    $pdf->Cell($newbie_spacer,$row_height,'',0,0,'L',0);
	  $pdf->Cell($newbie_address_width,$row_height,'My Town, 12345',$cell_border,0,'L',0);
	    $pdf->Cell($newbie_spacer,$row_height,'',0,0,'L',0);	    
	  $pdf->Cell($newbie_email_width,$row_height,'gmail.com',$cell_border,0,'L',0);
	    $pdf->Cell($newbie_spacer,$row_height,'',0,0,'L',0);
	  $pdf->Cell($newbie_phone_width,$row_height,'456-7890',$cell_border,0,'L',0);
	    $pdf->Cell($newbie_spacer,$row_height,'',0,0,'L',0);
	  $pdf->Cell($newbie_employer_width,$row_height,'Brick',$cell_border,0,'L',0);
	    $pdf->Cell($newbie_spacer,$row_height,'',0,0,'L',0);
	  $pdf->Cell($newbie_gender_width,$row_height,'',$cell_border,0,'L',0);
	    $pdf->Cell($newbie_spacer,$row_height,'',0,0,'L',0);
	  $pdf->Cell($newbie_dob_width,$row_height,'1985',$cell_border,0,'L',0);
	    $pdf->Cell($newbie_spacer,$row_height,'',0,0,'L',0);
	  $pdf->Cell($newbie_how_hear_width,$row_height,'',$cell_border,1,'L',0);

	  for($i = 2; $i<=$num_lines_per_page; $i++) {
	    $pdf->Cell($newbie_name_width,$newbie_row_height,'',$cell_border,0,'L',0);
	      $pdf->Cell($newbie_spacer,$newbie_row_height,'',0,0,'L',0);
	    $pdf->Cell($newbie_address_width,$newbie_row_height,'',$cell_border,0,'L',0);
	      $pdf->Cell($newbie_spacer,$newbie_row_height,'',0,0,'L',0);	    
	    $pdf->Cell($newbie_email_width,$newbie_row_height,'',$cell_border,0,'L',0);
	      $pdf->Cell($newbie_spacer,$newbie_row_height,'',0,0,'L',0);
	    $pdf->Cell($newbie_phone_width,$newbie_row_height,'',$cell_border,0,'L',0);
	      $pdf->Cell($newbie_spacer,$newbie_row_height,'',0,0,'L',0);
	    $pdf->Cell($newbie_employer_width,$newbie_row_height,'',$cell_border,0,'L',0);
	      $pdf->Cell($newbie_spacer,$newbie_row_height,'',0,0,'L',0);
	    $pdf->Cell($newbie_gender_width,$newbie_row_height,'',$cell_border,0,'L',0);
	      $pdf->Cell($newbie_spacer,$newbie_row_height,'',0,0,'L',0);
	    $pdf->Cell($newbie_dob_width,$newbie_row_height,'',$cell_border,0,'L',0);
	      $pdf->Cell($newbie_spacer,$newbie_row_height,'',0,0,'L',0);
	    $pdf->Cell($newbie_how_hear_width,$newbie_row_height,'',$cell_border,1,'L',0);
	  }
@


1.2
log
@*** empty log message ***
@
text
@d33 1
a33 1
function generate_page_top($pdf, $node, $page) {
d46 3
a48 3
  $contact_lastname = trim($event['contact_lastname']);
  if ($contact_lastname != '') {
    $contact_lastname = ' '.$contact_lastname;
d50 1
a50 1
  $contact_phone = trim($event['contact_phone']);
d54 1
a54 1
  $contact_email = trim($event['contact_email']);
d58 1
a58 1
  $contact_info = trim(trim($event['contact_firstname']).($contact_lastname).($contact_phone).($contact_email));
d92 2
a93 2
//  $pdf->Image('images/onebrick_72.png',45,20,99,62);
  
d98 1
a98 1
function get_roster($nid) {
d104 1
a104 1
		WHERE field_rsvp_event_nid = $nid
d144 16
a159 1
	return $all_volunteers;
d169 1
a169 4
//	$organization = node_load($node->field_event_organization['und'][0]['nid']);
//	print_r($organization);

	$all_volunteers = get_roster($nid);
d193 1
a193 1
	  generate_page_top($pdf, $node, $page+1);
d274 1
a274 1
	  generate_page_top($pdf, $node, $page+1);
@


1.1
log
@Initial revision
@
text
@d33 1
a33 1
function generate_page_top($pdf, $roster, $page) {
d38 2
a39 2
  $pdf->Cell(200,12,''.strip_tags($roster[0]['eventname']),0,1,'R',0);
  
d42 5
a46 3
  $pdf->Cell(200,12,''.trim($roster[0]['eventdate']).', '.trim($roster[0]['eventstart']).' - '.trim($roster[0]['eventend']).'',0,1,'R',0);
  
  $contact_lastname = trim($roster[0]['contact_lastname']);
d50 1
a50 1
  $contact_phone = trim($roster[0]['contact_phone']);
d54 1
a54 1
  $contact_email = trim($roster[0]['contact_email']);
d58 1
a58 1
  $contact_info = trim(trim($roster[0]['contact_firstname']).($contact_lastname).($contact_phone).($contact_email));
d67 5
a71 3
  $address2 = trim($roster[0]['address2']);
  if ($address2 != '') {
    $address2 = ', '.$address2;
d73 1
a73 5
  $city = trim($roster[0]['city']);
  if ($city != '') {
    $city = ', '.$city;
  }
  $address_info = trim(trim($roster[0]['address1']).($address2).($city));
d92 1
a92 1
  $pdf->Image('images/onebrick_72.png',45,20,99,62);
d97 62
a158 1
function generate_pdf() { 
d173 1
a173 1
	$num_spaces = sizeof($roster) * 1.2; // allocate space for 20% walk-ins
a176 6
	$i = 0;
	foreach($roster as $volunteer) {
	  $all_volunteers[$i] = $volunteer;
	  $i++;
	}

d181 1
a181 1
	  generate_page_top($pdf, $roster, $page+1);
d210 1
a210 1
	      if ($volunteer_index < sizeof($roster)) {
d219 2
a220 2
	    
		$pdf->Cell($printed_width,$row_height,''.($volunteer['firstname'].' '.$volunteer['lastname']).' '.($newbie).'',$cell_border,0,'L',0);
d262 1
a262 1
	  generate_page_top($pdf, $roster, $page+1);
d342 1
a342 1
	return $pdf->Output('PDF_Roster.pdf', 'S');
@
