head	1.9;
access;
symbols;
locks
	crc:1.9; strict;
comment	@# @;


1.9
date	2013.11.14.04.58.08;	author benson;	state Exp;
branches;
next	1.8;

1.8
date	2013.10.03.22.24.12;	author crc;	state Exp;
branches;
next	1.7;

1.7
date	2013.05.29.03.44.47;	author crc;	state Exp;
branches;
next	1.6;

1.6
date	2013.05.18.00.16.21;	author crc;	state Exp;
branches;
next	1.5;

1.5
date	2013.05.15.05.09.19;	author crc;	state Exp;
branches;
next	1.4;

1.4
date	2013.04.05.23.55.22;	author crc;	state Exp;
branches;
next	1.3;

1.3
date	2013.04.05.19.35.19;	author crc;	state Exp;
branches;
next	1.2;

1.2
date	2013.04.04.23.18.15;	author crc;	state Exp;
branches;
next	1.1;

1.1
date	2013.03.19.04.05.17;	author crc;	state Exp;
branches;
next	;


desc
@@


1.9
log
@added @@onebrick.org to some emails expansions
@
text
@<?php
// Move these into a misc file one day
function brick_org_contact_list($orgid) {
	return(db_query("SELECT * from ORG_CONTACT_LIST where orgid = ".$orgid.";"));
}

function brick_chapter_details($chapter_id) {
	return(db_query("SELECT * FROM CHAPTER_DETAILS where chapter_id = ".$chapter_id.";"));
}

function brick_site_address($node) {
	$address = "";
  if(isset($node->field_event_site)) {
    $site = node_load($node->field_event_site['und']['0']['nid']);
    if(isset($site->location))
      $address = location_address2singleline($site->location);
	}
 return($address);
}

function brick_event_from_to($event) {
// The string value is represented in one timezone (probably UTC),
// and we need to convert it to the target timezone instead.
	if (!function_exists('get_date')) {
		function get_date($str, $from_tz, $to_tz) {
			$obj = new DateTime($str, new DateTimeZone($from_tz));
			$obj->setTimezone(new DateTimeZone($to_tz));
			return $obj;
		}
	}
	$from_tz = $event->field_event_date['und'][0]['timezone_db'];
	$to_tz = $event->field_event_date['und'][0]['timezone'];
	$ts_from = get_date($event->field_event_date['und'][0]['value'], $from_tz, $to_tz);
	$ts_to = get_date($event->field_event_date['und'][0]['value2'], $from_tz, $to_tz); 

	// Put end date if the starting date does not match the end date, otherwise just
	// list start date and times.
	$from_date = $ts_from->format('M jS Y');
	$to_date = $ts_to->format('M jS Y');
	if ($from_date == $to_date) {
		$end = $ts_to->format('g:i a');
	} else {
		$end = $ts_to->format('M jS Y, g:i a');
	}

	$start = $ts_from->format('M jS Y, g:i a');
	return("$start - $end");
}

function brick_num_orgs() {
        $q = "SELECT count(*) FROM field_data_field_organization_chapter;";
        $r = db_query($q);
        return $r->fetchField();
}

function brick_num_hours($p = "ALL") {
  $q = "  SELECT truncate(sum(timestampdiff(minute,field_event_date_value, field_event_date_value2)/60.0), 0)
                FROM field_data_field_rsvp_event
                LEFT JOIN (field_data_field_rsvp_attended, field_data_field_event_type, field_data_field_event_date)
                ON (field_data_field_rsvp_event.entity_id = field_data_field_rsvp_attended.entity_id
                    AND field_rsvp_event_nid = field_data_field_event_date.entity_id
                    AND field_rsvp_event_nid = field_data_field_event_type.entity_id)
                WHERE field_rsvp_attended_value = 1 AND field_event_type_value = 'Volunteer' 
  ";

	if($p === "YTD") {
		$q .= " AND year(field_event_date_value) = year(curdate())";
	}
	$q .= ";";

  $r = db_query($q);
  return $r->fetchField();
}


// count people who have volunteered at least once
function brick_num_vols() {
  $q = "  SELECT COUNT(DISTINCT field_rsvp_person_uid)
    FROM field_data_field_user_fullname    LEFT JOIN (field_data_field_rsvp_attended, field_data_field_rsvp_event, field_data_field_event_type, field_data_field_rsvp_person)
    ON (field_data_field_user_fullname.entity_id = field_rsvp_person_uid        AND field_data_field_rsvp_person.entity_id = field_data_field_rsvp_attended.entity_id        AND field_data_field_rsvp_person.entity_id = field_data_field_rsvp_event.entity_id
        AND field_rsvp_event_nid = field_data_field_event_type.entity_id)    WHERE field_rsvp_attended_value = 1 AND field_event_type_value = 'Volunteer';
  ";
  $r = db_query($q);
  return $r->fetchField();
}

function brick_num_events($p = "Volunteer") {
  $q = "  SELECT COUNT(*)
    FROM field_data_field_event_type
    LEFT JOIN field_data_field_event_date
    ON field_data_field_event_type.entity_id = field_data_field_event_date.entity_id
    WHERE field_event_type_value = '".$p."' AND field_event_date_value2 < CURDATE();
  ";

  $r = db_query($q);
  return $r->fetchField();
}



// Returns an array of chapter names
function brick_chapter_list() {
$q = "
SELECT title FROM  node 
  LEFT JOIN field_revision_field_chapter_hide_from_menu
     ON field_revision_field_chapter_hide_from_menu.entity_id = nid
  WHERE TYPE = 'chapter'
  AND field_revision_field_chapter_hide_from_menu.field_chapter_hide_from_menu_value =  '0';";

	$chapter_list = array();

  $r = db_query($q);
	foreach ($r as $rec) {
		array_push($chapter_list, $rec->title);
	}
	return($chapter_list);
}

function brick_chapter_info($chapter_id) {
}


//debug function
function crc_log_to_file($text) {
  $f = fopen('/tmp/crc_log.txt', 'a');
  fwrite($f, date('Ymd H:i:s - ') . $text . "\n");
  fclose($f);
}

// helper functions
function brick_round_up10($n,$d) {
  return $n - $n % pow(10,$d);
}

function brick_array2commalist($list) {
 $comma_list = "";
 $list_length = count($list);
 foreach ($list as $elem) {
	 if ($list_length-- === 1) {
		 $comma_list .= "and ".$elem;
	 } else {
		 $comma_list .= $elem.", ";
	 }
 }
 return($comma_list);
}

/*
 * brick_merge_variables(string s) scans a string and replaces variables 
 */
// $s - String we are expanding variables into (the template)
// $event - node for the event we are looking at
// $to - user node for the person we intend to email
// $rsvp -  node for the person who just rsvp'ed
//
function brick_expand($s, $event = NULL, $to = NULL, $rsvp = NULL) {
	$c = "#brick_expand"; //This is the stub we will look for in the file

	// Performance optimization ... if no variables simply return
	if(strpos($s, $c) === FALSE) {
	 return($s);
	}

	if($rsvp && strpos($s, $c."(rsvp:")) {
				$s = str_replace($c."(rsvp:name)", "rsvp:name NOT IMPLEMENTED", $s);
				$s = str_replace($c."(rsvp:note)", "rsvp:name NOT IMPLEMENTED", $s);
	}

	if(strpos($s, $c."(stats:")) {
			$s = str_replace($c."(stats:num_orgs)", 
							number_format(brick_round_up10(brick_num_orgs(),2)), $s);
 			$s = str_replace($c."(stats:num_volunteers)", 
							number_format(brick_round_up10(brick_num_vols(),1)), $s);
 			$s = str_replace($c."(stats:hours)", 
							number_format(brick_round_up10(brick_num_hours("ALL"),3)), $s);
 			$s = str_replace($c."(stats:ytd_hours)", 
							number_format(brick_round_up10(brick_num_hours("YTD"),2)), $s);
 			$s = str_replace($c."(stats:num_events)", 
							number_format(brick_round_up10(brick_num_events(),1)), $s);
 			$s = str_replace($c."(stats:num_chapters)", count(brick_chapter_list()), $s);
 			$s = str_replace($c."(stats:chapter_list)", 
							brick_array2commalist(brick_chapter_list()), $s);
	}

 	// expand information about the event passed as param event
	if($event && strpos($s, $c."(event:")) { 
				global $base_url;
				$url= $base_url."/node/".$event->nid;

				$s = str_replace($c."(event:rsvp_count)", brick_rsvp_count($event->nid), $s);
				$s = str_replace($c."(event:rsvp_capacity)", 
								$event->field_event_max_rsvp_capacity['und'][0]['value'], $s);
				$s = str_replace($c."(event:date)", brick_event_from_to($event), $s);
				$s = str_replace($c."(event:name)", strip_tags($event->title), $s);
				$s = str_replace($c."(event:location)", brick_site_address($event), $s);

				$s = str_replace($c."(event:staff)", brick_format_managment_list($event, FALSE), $s);
				$s = str_replace($c."(event:page)", '<a href="'.$url.'">'.$url."</a>", $s);

////
////
////
////
				$contacts = brick_org_contact_list($event->field_event_organization['und']['0']['nid']);
 				/// while loop
				///
				//$s = str_replace($c."(event:orgname)", $org_name, $s);
				//$s = str_replace($c."(event:orgcontacts)", $org_contacts, $s);
			}

 	// expand information about the current user
	if(strpos($s, $c."(user:")) { 
				global $user;
				$account = user_load($user->uid);
				$name = brick_get_user_name($account);
				$email = $user && property_exists($user, "mail") ? $user->mail : "";

				$s = str_replace($c."(user:name)", $name, $s);
				$s = str_replace($c."(user:email)", $email, $s);
	}

 	// expand information about the user we are emailing
	if($to && strpos($s, $c."(email:")) { 
				$s = str_replace($c."(email:name)", "NAME NOT IMPLEMENTED YET", $s);
				$s = str_replace($c."(email:fname)", "FNAME NOT IMPLEMENTED YET", $s);
	}

 	// expand information about the current chapter
	if(strpos($s, $c."(chapter:")) { 

				$chapter_info = brick_chapter_details(brick_current_chapter())->fetchAssoc();
//crc_log_to_file($chapter_node->title);

				$s = str_replace($c."(chapter:name)", $chapter_info['name'], $s);
				$s = str_replace($c."(chapter:email_recruiting)", $chapter_info['email_recruiting'] . "@@onebrick.org", $s);
				$s = str_replace($c."(chapter:email_events)", $chapter_info['email_events'] . "@@onebrick.org", $s);
	}


	return($s);
}


@


1.8
log
@*** empty log message ***
@
text
@d235 2
a236 2
				$s = str_replace($c."(chapter:email_recruiting)", $chapter_info['email_recruiting'], $s);
				$s = str_replace($c."(chapter:email_events)", $chapter_info['email_events'], $s);
@


1.7
log
@*** empty log message ***
@
text
@d190 1
a190 1
				$s = str_replace($c."(event:rsvp_count)", brick_rsvp_count($event), $s);
@


1.6
log
@*** empty log message ***
@
text
@a148 1
 *
a149 25
 *
 * The supported variables are:
 *
 * stats:
 * 	num_orgs *  num_volunteers *	hours * 	ytd_hours *  chapter_list
 *
 *
 * email:
 * 	from_fname	* 	from_sname * 	to_fname * 	to_sname
 *
 * event:
 * 	name	- name of the event 
 * 	date - date of the event
 * 	loc	-	name of the event location
 * 	org	- the name of the organization associated with the event
 * 	contacts	-	a list of the organizational contacts for the event
 * 	url	-	URL of the event page
 *
 * user:
 * 	name	-	name of the current user
 * 	email	-	email of the current user
 *
 * rsvp_note	- note left by the user when they rsvp'd to the event
 * password		- new password, set by the system
 *
d151 1
a151 1
// $s - String we are expanding variables into
d154 1
d156 1
a156 1
function brick_expand($s, $event = NULL, $to = NULL) {
d164 5
a168 1
 	// expand information about the interesting stats
a197 1

d200 10
a209 3
				$s = str_replace($c."(event:org_name)", $org_name, $s);
				$s = str_replace($c."(event:org_contacts)", $org_contacts, $s);
	}
d224 2
a225 1
				$s = str_replace($c."(email:name)", "NOT IMPLEMENTED YET", $s);
@


1.5
log
@*** empty log message ***
@
text
@d3 4
d8 1
a8 22
$q = "SELECT node.title as name, 
				field_chapter_recruiting_email_value as email_recruiting,
				field_chapter_events_email_value as email_events,
				field_chapter_twitter_url_value as twitter,
				field_chapter_facebook_url_value as facebook,
				field_chapter_craigslist_stub_value as cl_stub,
				field_chapter_craigslist_code_value as cl_code
FROM `node` 
				LEFT JOIN field_data_field_chapter_recruiting_email on 
								field_data_field_chapter_recruiting_email.entity_id = node.nid
				LEFT JOIN field_data_field_chapter_events_email on 
								field_data_field_chapter_events_email.entity_id = node.nid
				LEFT JOIN  field_data_field_chapter_twitter_url on 
								field_data_field_chapter_twitter_url.entity_id = node.nid
				LEFT JOIN field_data_field_chapter_facebook_url on 
								field_data_field_chapter_facebook_url.entity_id = node.nid
				LEFT JOIN field_data_field_chapter_craigslist_stub on 
								field_data_field_chapter_craigslist_stub.entity_id = node.nid
				LEFT JOIN  field_data_field_chapter_craigslist_code on 
								field_data_field_chapter_craigslist_code.entity_id = node.nid
where nid = ".$chapter_id.";";
return(db_query($q)->fetchAssoc());
d208 3
a215 1
				$s = str_replace($c."(event:internal_page)", "NOT IMPLEMENTED", $s);
a218 1
				$s = str_replace($c."(event:external_page)", "NOT IMPLEMENTED YET", $s);
d220 1
a220 3
				if(isset($event->field_event_organization)) {
					$org = node_load($event->field_event_organization['und']['0']['nid']);
				}
d222 2
a223 2
				$s = str_replace($c."(event:org_name)", $org->title, $s);
				$s = str_replace($c."(event:org_contact)", "NOT IMPLEMENTED YET", $s);
d244 2
a245 1
				$chapter_info = brick_chapter_details(brick_current_chapter());
d257 1
@


1.4
log
@*** empty log message ***
@
text
@d3 25
d136 4
d187 2
a188 2
 * 	fname	-	first name of the current user
 * 	sname	-	first name of the current user
d213 1
a213 1
							number_format(brick_round_up10(brick_num_hours(),3)), $s);
a224 1
				$s = str_replace($c."(email:to_firstname)", "", $s);
d234 1
a234 1
				$s = str_replace($c."(event:internal_page)", "", $s);
d241 1
a241 1
				$s = str_replace($c."(event:org_contact)", "", $s);
d245 8
a252 2
	if(strpos($s, $c."(event:")) { 
				$s = str_replace($c."(user:firstname)", "", $s);
d255 16
@


1.3
log
@*** empty log message ***
@
text
@d2 9
a10 5
//debug function
function crc_log_to_file($text) {
  $f = fopen('/tmp/crc_log.txt', 'a');
  fwrite($f, date('Ymd H:i:s - ') . $text . "\n");
  fclose($f);
d13 24
a36 4
// helper functions
function brick_round_up10($n,$d) {
  return $n - $n % pow(10,$d);
}
d38 2
a39 11
function brick_array2commalist($list) {
 $comma_list = "";
 $list_length = count($list);
 foreach ($list as $elem) {
	 if ($list_length-- === 1) {
		 $comma_list .= "and ".$elem;
	 } else {
		 $comma_list .= $elem.", ";
	 }
 }
 return($comma_list);
a41 33
/*
 *
 * brick_merge_variables(string s) scans a string and replaces variables 
 *
 * The supported variables are:
 *
 * stats:
 * 	num_orgs *  num_volunteers *	hours * 	ytd_hours *  chapter_list
 *
 *
 * email:
 * 	from_fname	* 	from_sname * 	to_fname * 	to_sname
 *
 * event:
 * 	name	- name of the event 
 * 	date - date of the event
 * 	start- event start time
 * 	end	- event end time
 * 	loc	-	name of the event location
 * 	org	- the name of the organization associated with the event
 * 	contacts	-	a list of the organizational contacts for the event
 * 	url	-	URL of the event page
 *
 * user:
 * 	fname	-	first name of the current user
 * 	sname	-	first name of the current user
 *
 * rsvp_note	- note left by the user when they rsvp'd to the event
 * password		- new password, set by the system
 *
 */


d111 59
a169 1
function brick_expand($s) {
d194 21
d216 3
a218 1
	if(strpos($s, $c."(event:")) { // expand information about the current event
@


1.2
log
@*** empty log message ***
@
text
@d2 1
d9 18
d34 1
a34 5
 * 	num_orgs
 *  num_volunteers
 *	hours
 * 	ytd_hours
 *  chapter_list
d38 1
a38 4
 * 	from_fname	
 * 	from_sname
 * 	to_fname
 * 	to_sname
a58 4
function round_up10($n,$d) {
  return $n - $n % pow(10,$d);
}

a80 3
crc_log_to_file($q);


a109 6
function brick_num_chapters() {
	$q = "SELECT COUNT(*) FROM  node 
	LEFT JOIN field_revision_field_chapter_hide_from_menu
		 ON field_revision_field_chapter_hide_from_menu.entity_id = nid
	WHERE TYPE = \"chapter\"
	AND field_revision_field_chapter_hide_from_menu.field_chapter_hide_from_menu_value =  '0';";
d111 8
a118 4
crc_log_to_file($q);
  $r = db_query($q);
  return $r->fetchField();
}
d120 1
d122 5
a126 2
function brick_chapters_list() {
	return("SF,SV, ...");
d137 2
a138 2

	if(strpos($s, $c."(stats:")) { // expand information about the interesting stats
d140 1
a140 1
							number_format(round_up10(brick_num_orgs(),2)), $s);
d142 1
a142 1
							number_format(round_up10(brick_num_vols(),1)), $s);
d144 1
a144 1
							number_format(round_up10(brick_num_hours(),3)), $s);
d146 1
a146 1
							number_format(round_up10(brick_num_hours("YTD"),2)), $s);
d148 4
a151 3
							number_format(round_up10(brick_num_events(),1)), $s);
 			//$s = str_replace($c."(stats:num_chapters)", brick_num_chapters(), $s);
 			//$s = str_replace($c."(stats:chapter_list)", brick_chapters_list(), $s);
@


1.1
log
@Initial revision
@
text
@d2 5
d47 75
d132 12
a143 5
			$s = str_replace($c."(stats:num_orgs)", "1,200", $s);
 			$s = str_replace($c."(stats:num_volunteers)", "40,000", $s);
 			$s = str_replace($c."(stats:hours)", "400,000", $s);
 			$s = str_replace($c."(stats:ytd_hours)", "7,000", $s);
 			$s = str_replace($c."(stats:chapter_list)", "San Francisco, Silicon Valley, Washington DC, ...", $s);
@
